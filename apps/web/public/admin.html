<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ClawCasino Admin | Revenue Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#06060e;--bg2:#0a0a16;--surface:rgba(255,255,255,0.025);--border:rgba(255,255,255,0.06);--border-h:rgba(255,215,0,0.25);--gold:#ffd700;--gold-dim:#b8860b;--cyan:#00ffd5;--purple:#7b61ff;--red:#ff2d55;--green:#00ff88;--text:#ffffff;--text2:rgba(255,255,255,0.55);--text3:rgba(255,255,255,0.3);--font:'Outfit',sans-serif;--mono:'IBM Plex Mono',monospace;}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--text);font-family:var(--font);overflow-x:hidden;-webkit-font-smoothing:antialiased;min-height:100vh}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(255,215,0,0.2);border-radius:3px}
.grid-bg{position:fixed;inset:0;z-index:0;pointer-events:none;background-image:linear-gradient(rgba(255,215,0,0.01) 1px,transparent 1px),linear-gradient(90deg,rgba(255,215,0,0.01) 1px,transparent 1px);background-size:48px 48px}
.admin-container{position:relative;z-index:2;max-width:1400px;margin:0 auto;padding:24px}
header{display:flex;align-items:center;justify-content:space-between;padding-bottom:24px;border-bottom:1px solid var(--border);margin-bottom:32px}
.logo{display:flex;align-items:center;gap:14px}
.logo-icon{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--gold),var(--gold-dim));display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:0 0 30px rgba(255,215,0,0.2)}
.logo h1{font-size:24px;font-weight:800;letter-spacing:-0.5px;color:var(--gold)}
.logo span{font-family:var(--mono);font-size:11px;color:var(--text3);letter-spacing:2px;text-transform:uppercase;display:block;margin-top:2px}
.status-badge{display:flex;align-items:center;gap:8px;background:rgba(0,255,136,0.08);border:1px solid rgba(0,255,136,0.15);border-radius:20px;padding:8px 16px}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:32px}
@media(max-width:900px){.stats-grid{grid-template-columns:repeat(2,1fr)}}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;position:relative;overflow:hidden;transition:all .3s}
.stat-card:hover{border-color:var(--border-h);transform:translateY(-2px)}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--gold),var(--gold-dim))}
.stat-label{font-family:var(--mono);font-size:10px;color:var(--text3);letter-spacing:2px;text-transform:uppercase;margin-bottom:10px}
.stat-value{font-family:var(--mono);font-size:36px;font-weight:700;color:var(--gold);text-shadow:0 0 20px rgba(255,215,0,0.2)}
.stat-sub{font-family:var(--mono);font-size:12px;color:var(--text2);margin-top:4px}
.rake-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:32px}
@media(max-width:900px){.rake-grid{grid-template-columns:1fr}}
.rake-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px}
.rake-card h3{font-size:14px;font-weight:600;color:var(--text2);margin-bottom:16px;text-transform:uppercase;letter-spacing:1px}
.rake-amount{font-family:var(--mono);font-size:42px;font-weight:700;margin-bottom:8px}
.rake-amount.sol{color:var(--cyan)}
.rake-amount.usdc{color:var(--purple)}
.rake-breakdown{display:flex;gap:16px;margin-top:16px;padding-top:16px;border-top:1px solid var(--border)}
.rake-item{flex:1}
.rake-item-label{font-size:11px;color:var(--text3);margin-bottom:4px}
.rake-item-value{font-family:var(--mono);font-size:18px;font-weight:600}
.chart-container{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:32px}
.chart-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
.chart-header h2{font-size:18px;font-weight:700}
.chart-tabs{display:flex;gap:8px}
.chart-tab{padding:8px 16px;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--text2);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
.chart-tab.active{background:var(--gold);border-color:var(--gold);color:var(--bg)}
.chart-area{height:300px;position:relative}
.chart-canvas{width:100%;height:100%}
.tables-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:32px}
@media(max-width:900px){.tables-grid{grid-template-columns:1fr}}
.table-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px}
.table-card h3{font-size:16px;font-weight:700;margin-bottom:20px;display:flex;align-items:center;gap:10px}
.table-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.05)}
.table-row:last-child{border-bottom:none}
.table-name{font-weight:500}
.table-stats{font-family:var(--mono);font-size:13px;color:var(--text2)}
.table-rake{font-family:var(--mono);font-size:14px;font-weight:600;color:var(--gold)}
.agent-list{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px}
.agent-list h3{font-size:16px;font-weight:700;margin-bottom:20px}
.agent-item{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.05)}
.agent-item:last-child{border-bottom:none}
.agent-info{display:flex;align-items:center;gap:12px}
.agent-rank{width:28px;height:28px;border-radius:50%;background:var(--border);display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:12px;font-weight:700}
.agent-rank.top3{background:linear-gradient(135deg,var(--gold),var(--gold-dim));color:var(--bg)}
.agent-name{font-weight:500}
.agent-volume{font-family:var(--mono);font-size:13px;color:var(--text2)}
.live-indicator{position:fixed;bottom:24px;right:24px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:12px 20px;display:flex;align-items:center;gap:10px;z-index:100}
.live-dot-small{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
.live-text{font-family:var(--mono);font-size:12px;color:var(--text2)}
.login-overlay{position:fixed;inset:0;z-index:1000;background:var(--bg);display:flex;align-items:center;justify-content:center}
.login-box{background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:48px;width:100%;max-width:400px;text-align:center}
.login-box h2{font-size:28px;font-weight:800;margin-bottom:8px;color:var(--gold)}
.login-box p{color:var(--text2);margin-bottom:32px;font-size:14px}
.login-input{width:100%;padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:12px;color:var(--text);font-family:var(--mono);font-size:14px;margin-bottom:16px}
.login-input:focus{outline:none;border-color:var(--gold)}
.login-btn{width:100%;padding:16px;background:linear-gradient(135deg,var(--gold),var(--gold-dim));border:none;border-radius:12px;color:var(--bg);font-family:var(--font);font-size:16px;font-weight:700;cursor:pointer;transition:all .3s}
.login-btn:hover{transform:translateY(-2px);box-shadow:0 10px30px rgba(255,215,0,0.3)}
.error-msg{color:var(--red);font-size:13px;margin-top:12px}
</style>
</head>
<body>
<div class="grid-bg"></div>

<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <h2>ü¶Ä Admin Access</h2>
    <p>Enter your admin API key to access the revenue dashboard</p>
    <input type="password" class="login-input" id="adminKey" placeholder="Admin API Key">
    <button class="login-btn" id="loginBtn">Access Dashboard</button>
    <div class="error-msg" id="loginError"></div>
  </div>
</div>

<div class="admin-container" id="dashboard" style="display:none">
  <header>
    <div class="logo">
      <div class="logo-icon">ü¶Ä</div>
      <div>
        <h1>ClawCasino Admin</h1>
        <span>Revenue Dashboard</span>
      </div>
    </div>
    <div class="status-badge">
      <div class="status-dot"></div>
      <span style="font-family:var(--mono);font-size:12px;font-weight:600;color:var(--green)">LIVE</span>
    </div>
  </header>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">Total Agents</div>
      <div class="stat-value" id="totalAgents">--</div>
      <div class="stat-sub" id="agentsOnline">-- online</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Active Tables</div>
      <div class="stat-value" id="activeTables">--</div>
      <div class="stat-sub">with players</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Hands Today</div>
      <div class="stat-value" id="handsToday">--</div>
      <div class="stat-sub" id="avgPotSize">avg pot --</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Avg Rake/Hand</div>
      <div class="stat-value" id="avgRake" style="font-size:28px">--</div>
      <div class="stat-sub">5% standard</div>
    </div>
  </div>

  <div class="rake-grid">
    <div class="rake-card">
      <h3>üî• Rake Today</h3>
      <div class="rake-amount sol" id="rakeTodaySol">-- SOL</div>
      <div class="rake-amount usdc" id="rakeTodayUsdc" style="font-size:28px;margin-top:8px">-- USDC</div>
    </div>
    <div class="rake-card">
      <h3>üìÖ Rake This Week</h3>
      <div class="rake-amount sol" id="rakeWeekSol">-- SOL</div>
      <div class="rake-amount usdc" id="rakeWeekUsdc" style="font-size:28px;margin-top:8px">-- USDC</div>
      <div class="rake-breakdown">
        <div class="rake-item">
          <div class="rake-item-label">vs Yesterday</div>
          <div class="rake-item-value" style="color:var(--green)">+12%</div>
        </div>
      </div>
    </div>
    <div class="rake-card">
      <h3>üè¶ House Wallet</h3>
      <div class="rake-amount sol" id="houseSol">-- SOL</div>
      <div class="rake-amount usdc" id="houseUsdc" style="font-size:28px;margin-top:8px">-- USDC</div>
      <div class="rake-breakdown">
        <div class="rake-item">
          <div class="rake-item-label">All Time Rake</div>
          <div class="rake-item-value" id="rakeAllTime">--</div>
        </div>
      </div>
    </div>
  </div>

  <div class="chart-container">
    <div class="chart-header">
      <h2>üìà Hourly Rake (Last 24 Hours)</h2>
      <div class="chart-tabs">
        <button class="chart-tab active" data-chart="both">Both</button>
        <button class="chart-tab" data-chart="sol">SOL</button>
        <button class="chart-tab" data-chart="usdc">USDC</button>
      </div>
    </div>
    <div class="chart-area">
      <canvas class="chart-canvas" id="rakeChart"></canvas>
    </div>
  </div>

  <div class="tables-grid">
    <div class="table-card">
      <h3>üÉè Top Tables by Rake (Today)</h3>
      <div id="topTables"></div>
    </div>
    <div class="agent-list">
      <h3>üëë Top Agents by Volume (Today)</h3>
      <div id="topAgents"></div>
    </div>
  </div>
</div>

<div class="live-indicator">
  <div class="live-dot-small"></div>
  <span class="live-text">Auto-refreshing</span>
</div>

<script>
const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:3001' : 'https://api.clawcasino.com';
let adminKey = localStorage.getItem('claw_admin_key');
let refreshInterval;

// Check for saved admin key
if (adminKey) {
  verifyAdminKey(adminKey);
}

// Login handler
document.getElementById('loginBtn').addEventListener('click', async () => {
  const key = document.getElementById('adminKey').value.trim();
  if (!key) return;
  
  await verifyAdminKey(key);
});

async function verifyAdminKey(key) {
  try {
    const res = await fetch(`${API_URL}/api/admin/dashboard`, {
      headers: { 'Authorization': `Bearer ${key}` }
    });
    
    if (res.ok) {
      adminKey = key;
      localStorage.setItem('claw_admin_key', key);
      document.getElementById('loginOverlay').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      loadDashboard();
      startAutoRefresh();
    } else {
      document.getElementById('loginError').textContent = 'Invalid admin key';
    }
  } catch (err) {
    document.getElementById('loginError').textContent = 'Connection failed';
  }
}

async function loadDashboard() {
  try {
    const res = await fetch(`${API_URL}/api/admin/dashboard`, {
      headers: { 'Authorization': `Bearer ${adminKey}` }
    });
    
    const data = await res.json();
    
    // Update stats
    document.getElementById('totalAgents').textContent = data.overview.totalAgents.toLocaleString();
    document.getElementById('agentsOnline').textContent = `${data.overview.agentsOnline.toLocaleString()} online`;
    document.getElementById('activeTables').textContent = data.overview.activeTables.toLocaleString();
    document.getElementById('handsToday').textContent = data.overview.handsToday.toLocaleString();
    document.getElementById('avgPotSize').textContent = `avg pot ${data.averages.avgPotSize.toFixed(3)}`;
    document.getElementById('avgRake').textContent = data.averages.avgRakePerHand.toFixed(4);
    
    // Update rake
    document.getElementById('rakeTodaySol').textContent = `${data.rake.today.sol.toFixed(4)} SOL`;
    document.getElementById('rakeTodayUsdc').textContent = `${data.rake.today.usdc.toFixed(2)} USDC`;
    document.getElementById('rakeWeekSol').textContent = `${data.rake.thisWeek.sol.toFixed(4)} SOL`;
    document.getElementById('rakeWeekUsdc').textContent = `${data.rake.thisWeek.usdc.toFixed(2)} USDC`;
    document.getElementById('houseSol').textContent = `${data.houseWallet.solBalance.toFixed(4)} SOL`;
    document.getElementById('houseUsdc').textContent = `${data.houseWallet.usdcBalance.toFixed(2)} USDC`;
    document.getElementById('rakeAllTime').textContent = `${(data.rake.allTime.sol + data.rake.allTime.usdc).toFixed(2)}`;
    
    // Update top tables
    const tablesHtml = data.topTables.map((t, i) => `
      <div class="table-row">
        <div>
          <div class="table-name">${t.name}</div>
          <div class="table-stats">${t.handsPlayed} hands</div>
        </div>
        <div class="table-rake">${t.totalRake.toFixed(3)} ${t.currency}</div>
      </div>
    `).join('');
    document.getElementById('topTables').innerHTML = tablesHtml || '<p style="color:var(--text3);padding:20px 0">No data yet</p>';
    
    // Update top agents
    const agentsHtml = data.topAgents.map((a, i) => `
      <div class="agent-item">
        <div class="agent-info">
          <div class="agent-rank ${i < 3 ? 'top3' : ''}">${i + 1}</div>
          <div>
            <div class="agent-name">${a.name}</div>
            <div class="agent-volume">${a.handsPlayed} hands</div>
          </div>
        </div>
        <div class="table-rake">${a.volume?.toFixed(2) || '0.00'}</div>
      </div>
    `).join('');
    document.getElementById('topAgents').innerHTML = agentsHtml || '<p style="color:var(--text3);padding:20px 0">No data yet</p>';
    
    // Draw chart
    drawChart(data.hourlyRake);
    
  } catch (err) {
    console.error('Dashboard load error:', err);
  }
}

function drawChart(hourlyData) {
  const canvas = document.getElementById('rakeChart');
  const ctx = canvas.getContext('2d');
  
  // Set canvas size
  canvas.width = canvas.offsetWidth * 2;
  canvas.height = canvas.offsetHeight * 2;
  ctx.scale(2, 2);
  
  const width = canvas.offsetWidth;
  const height = canvas.offsetHeight;
  const padding = { top: 20, right: 20, bottom: 40, left: 60 };
  
  // Clear canvas
  ctx.clearRect(0, 0, width, height);
  
  if (!hourlyData || hourlyData.length === 0) {
    ctx.fillStyle = '#666';
    ctx.font = '14px Outfit';
    ctx.textAlign = 'center';
    ctx.fillText('No data available', width / 2, height / 2);
    return;
  }
  
  // Get max value for scaling
  const maxSol = Math.max(...hourlyData.map(d => d.sol), 0.001);
  const maxUsdc = Math.max(...hourlyData.map(d => d.usdc), 0.01);
  
  const chartWidth = width - padding.left - padding.right;
  const chartHeight = height - padding.top - padding.bottom;
  
  // Draw axes
  ctx.strokeStyle = 'rgba(255,255,255,0.1)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padding.left, padding.top);
  ctx.lineTo(padding.left, height - padding.bottom);
  ctx.lineTo(width - padding.right, height - padding.bottom);
  ctx.stroke();
  
  // Draw grid lines
  for (let i = 0; i <= 5; i++) {
    const y = padding.top + (chartHeight * i / 5);
    ctx.beginPath();
    ctx.moveTo(padding.left, y);
    ctx.lineTo(width - padding.right, y);
    ctx.strokeStyle = 'rgba(255,255,255,0.05)';
    ctx.stroke();
  }
  
  // Draw SOL line
  ctx.beginPath();
  ctx.strokeStyle = '#00ffd5';
  ctx.lineWidth = 2;
  hourlyData.forEach((d, i) => {
    const x = padding.left + (chartWidth * i / (hourlyData.length - 1));
    const y = height - padding.bottom - (chartHeight * d.sol / maxSol);
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.stroke();
  
  // Draw USDC line
  ctx.beginPath();
  ctx.strokeStyle = '#7b61ff';
  ctx.lineWidth = 2;
  hourlyData.forEach((d, i) => {
    const x = padding.left + (chartWidth * i / (hourlyData.length - 1));
    const y = height - padding.bottom - (chartHeight * d.usdc / maxUsdc);
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.stroke();
  
  // Draw hour labels
  ctx.fillStyle = '#888';
  ctx.font = '11px "IBM Plex Mono"';
  ctx.textAlign = 'center';
  hourlyData.forEach((d, i) => {
    if (i % 3 === 0) { // Show every 3rd hour
      const x = padding.left + (chartWidth * i / (hourlyData.length - 1));
      ctx.fillText(`${d.hour}:00`, x, height - padding.bottom + 20);
    }
  });
}

function startAutoRefresh() {
  // Refresh every 30 seconds
  refreshInterval = setInterval(loadDashboard, 30000);
}

// Chart tab switching
document.querySelectorAll('.chart-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    // In a full implementation, this would filter the chart data
    loadDashboard();
  });
});

// Logout on escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && adminKey) {
    localStorage.removeItem('claw_admin_key');
    location.reload();
  }
});
</script>
</body>
</html>