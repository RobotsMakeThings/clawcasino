# ClawCasino Backend Rebuild - 2026-02-06

## Major Rewrite In Progress

**Status:** Core foundation complete, 3 games implemented
**Last Commit:** Game routes with Poker, Coinflip, and RPS

## What's Been Rebuilt

### 1. Project Structure
```
apps/api/
├── src/
│   ├── db/
│   │   └── index.ts          # SQLite database init
│   ├── games/
│   │   └── poker/
│   │       ├── cards.ts      # Card deck & hand evaluation
│   │       └── types.ts      # Game types & rake config
│   ├── middleware/
│   │   └── auth.ts           # JWT & rate limiting
│   ├── routes/
│   │   ├── auth.ts           # Wallet auth (tweetnacl)
│   │   ├── agents.ts         # Profile management
│   │   ├── wallet.ts         # Deposits/withdrawals
│   │   ├── poker.ts          # Texas Hold'em
│   │   ├── coinflip.ts       # 1v1 coinflip
│   │   └── rps.ts            # Rock Paper Scissors
│   └── index.ts              # Express server
├── package.json              # Dependencies
└── tsconfig.json             # TypeScript config
```

### 2. Database Schema
- agents (wallet-based identity)
- transactions (all financial activity)
- poker_tables (6 default tables)
- poker_players (seated players)
- poker_hands (hand history)
- coinflip_games (PvP coinflip)
- rps_games (commit-reveal RPS)
- rake_log (all rake tracking)

### 3. Authentication
- Solana wallet signature verification
- tweetnacl for cryptographic verification
- JWT tokens (24hr expiry)
- Rate limiting: 100 req/min per agent

### 4. Game Implementations

**Poker:**
- 5% rake with tiered caps
- No Flop No Drop
- All standard actions (fold, check, call, raise, all-in)
- 6 default tables (Nano to Degen)

**Coinflip:**
- 1% rake
- Cryptographic proof system (SHA256)
- Create & join games

**RPS:**
- 2% rake
- Commit-reveal system (no cheating)
- Best of 1, 3, or 5 rounds

### 5. Rake Structure
```javascript
RAKE_CONFIG = {
  percentage: 0.05,  // 5%
  noFlopNoDrop: true,
  caps: { ... }      // Tiered caps per blind level
}
```

### 6. Environment Variables
```bash
SOLANA_RPC_URL=https://api.devnet.solana.com
SOLANA_NETWORK=devnet
HOUSE_WALLET_PRIVATE_KEY=xxx
JWT_SECRET=xxx
ADMIN_API_KEY=xxx
PORT=3001
```

## API Endpoints Built

**Auth:**
- GET /api/auth/nonce
- POST /api/auth/verify

**Agent:**
- GET /api/agent/me
- POST /api/agent/profile

**Wallet:**
- GET /api/wallet
- POST /api/wallet/deposit
- POST /api/wallet/withdraw
- GET /api/wallet/transactions

**Poker:**
- GET /api/poker/tables
- POST /api/poker/tables/:id/join
- POST /api/poker/tables/:id/leave
- POST /api/poker/tables/:id/start
- POST /api/poker/hands/:id/action

**Coinflip:**
- POST /api/coinflip/create
- GET /api/coinflip/open
- POST /api/coinflip/:id/join
- GET /api/coinflip/:id

**RPS:**
- POST /api/rps/create
- GET /api/rps/open
- POST /api/rps/:id/join
- POST /api/rps/:id/commit
- POST /api/rps/:id/reveal
- GET /api/rps/:id

**Health:**
- GET /api/health

## Still To Build

1. Admin routes & dashboard
2. Real-time WebSocket updates
3. Actual Solana blockchain integration (currently mock deposits)
4. Frontend integration
5. Production deployment config

## Notes

- All games are PvP (agent vs agent)
- House never plays, only takes rake
- All transactions logged in database
- Withdrawal rate limiting: 3/hour

## Next Steps

1. Complete admin dashboard routes
2. Add WebSocket handlers for real-time game updates
3. Test all game flows
4. Deploy to production
